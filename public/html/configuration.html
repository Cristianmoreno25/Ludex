<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configuración de cuenta</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../css/views.css">
  <link rel="stylesheet" href="../css/submenu.css">
  <link rel="stylesheet" href="../css/configuration.css">
</head>
<body>
  <header class="page-header">
    <div class="page-left">
      <svg class="brand-mark" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" fill="#4f46e5" />
      </svg>
      <div>
        <span class="page-title">Configuraciones</span>
        <p class="page-subtitle">Actualiza tus datos y preferencias</p>
      </div>
    </div>
    <div class="topbar-right" role="navigation" aria-label="Accesos rápidos">
      <button class="icon-btn cart-btn" aria-label="Carrito" title="Carrito">
        <a href="./carrito.html" aria-hidden="true"><i class="fa-solid fa-cart-shopping"></i></a>
      </button>
      <!-- Avatar inyectado por submenu.js -->
    </div>
  </header>
  <div id="submenu-container" aria-hidden="true"></div>

  <main class="settings-main">
    <section class="settings-hero">
      <div class="hero-avatar" id="cfgAvatar" aria-label="Avatar">U</div>
      <div>
        <h2 id="cfgName">Tu nombre</h2>
        <p id="cfgHandle" class="muted">@usuario</p>
        <p class="muted">Actualiza tus datos básicos o cambia tu contraseña cuando lo necesites.</p>
        <div class="hero-actions">
          <button class="btn ghost" id="btn-change-avatar" type="button">Cambiar foto</button>
          <input type="file" id="avatarInput" accept="image/*" hidden>
        </div>
      </div>
    </section>

    <div id="cfg-msg" class="cfg-message" hidden></div>

    <section class="settings-grid">
      <article class="settings-card">
        <header>
          <h3>Editar perfil</h3>
          <p class="muted">Estos cambios afectan cómo apareces en la plataforma.</p>
        </header>
        <form id="form-profile" autocomplete="off" class="form">
          <label>Nombre completo
            <input type="text" id="input-name" placeholder="Tu nombre">
          </label>
          <label>Nombre de usuario
            <input type="text" id="input-username" placeholder="nombre_unico">
          </label>
          <label>Correo electrónico
            <input type="email" id="input-email" placeholder="correo@ejemplo.com">
          </label>
          <label>Teléfono
            <input type="tel" id="input-phone" placeholder="+57 300 000 0000">
          </label>
          <button type="submit" class="btn primary" id="btn-save-profile">Guardar cambios</button>
        </form>
      </article>

      <article class="settings-card">
        <header>
          <h3>Cambiar contraseña</h3>
          <p class="muted">Recomendamos actualizarla periódicamente.</p>
        </header>
        <form id="form-pass" autocomplete="off" class="form">
          <label>Contraseña actual
            <input type="password" id="input-curr-pass" placeholder="••••••">
          </label>
          <label>Nueva contraseña
            <input type="password" id="input-new-pass" placeholder="••••••">
          </label>
          <label>Confirmar nueva contraseña
            <input type="password" id="input-new-pass-confirm" placeholder="••••••">
          </label>
          <div class="form-row">
            <button type="submit" class="btn">Actualizar contraseña</button>
            <a href="./recovery.html" class="link">Olvidé mi contraseña</a>
          </div>
        </form>
      </article>

      <article class="settings-card">
        <header>
          <h3>Preferencias</h3>
          <p class="muted">Controla las notificaciones asociadas a tu cuenta.</p>
        </header>
        <form id="form-prefs" class="form">
          <label class="toggle">
            <input type="checkbox" id="input-notif">
            <span>Recibir notificaciones importantes</span>
          </label>
          <button type="submit" class="btn primary">Guardar preferencias</button>
        </form>
      </article>
    </section>
  </main>

  <script src="../js/submenu.js" defer></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const $ = (id) => document.getElementById(id);
    const msgEl = $('cfg-msg');
    const avatarEl = $('cfgAvatar');
    const nameDisplay = $('cfgName');
    const handleDisplay = $('cfgHandle');

    let supabase;
    let currentUser = null;

    async function getClient() {
      if (supabase) return supabase;
      const env = await fetch('/api/public-env').then((r) => r.json());
      supabase = createClient(env.url, env.key);
      return supabase;
    }

    function showMsg(text, type = 'info', timeout = 4000) {
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.dataset.state = type;
      msgEl.hidden = false;
      if (timeout) {
        setTimeout(() => (msgEl.hidden = true), timeout);
      }
    }

    function setAvatar(url, username) {
      if (!avatarEl) return;
      if (url) {
        avatarEl.innerHTML = '';
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Foto de perfil';
        avatarEl.appendChild(img);
      } else {
        const letter = (username || 'u').charAt(0).toUpperCase();
        avatarEl.textContent = letter;
      }
    }

    async function loadProfile() {
      showMsg('Cargando perfil...', 'info', 2000);
      const client = await getClient();
      const { data, error } = await client.auth.getUser();
      if (error || !data?.user) {
        showMsg('Inicia sesión para continuar', 'error', 2000);
        setTimeout(() => (window.location.href = '/html/login.html'), 1200);
        return;
      }
      const user = data.user;
      currentUser = user;
      const md = user.user_metadata || {};

      let perfil = null;
      try {
        const { data: perfilData } = await client
          .from('usuarios')
          .select('usuario, correo_electronico, nombre_completo, telefono, avatar_path')
          .eq('correo_electronico', user.email)
          .maybeSingle();
        perfil = perfilData;
      } catch (e) {
        console.log('No se pudo leer public.usuarios:', e);
      }

      const nombre = perfil?.nombre_completo || md.full_name || user.email || 'Usuario';
      const usuario = perfil?.usuario || md.username || (user.email?.split('@')[0] || 'usuario');
      const telefono = perfil?.telefono || md.phone || '';
      const correo = perfil?.correo_electronico || user.email || '';

      $('input-name').value = nombre || '';
      $('input-username').value = usuario || '';
      $('input-phone').value = telefono || '';
      $('input-email').value = correo || '';

      nameDisplay.textContent = nombre;
      handleDisplay.textContent = '@' + usuario;

      let avatarUrl = null;
      if (perfil?.avatar_path) {
        const env = await fetch('/api/public-env').then((r) => r.json());
        avatarUrl = `${env.url}/storage/v1/object/public/avatars/${encodeURIComponent(perfil.avatar_path)}`;
      } else {
        avatarUrl = md.avatar_url || md.picture || null;
      }
      setAvatar(avatarUrl, usuario);

      await loadPreferences(client, user.id);
    }

    async function loadPreferences(client, uid) {
      try {
        const { data } = await client
          .from('preferencias_usuarios')
          .select('notificaciones')
          .eq('user_auth_id', uid)
          .maybeSingle();
        $('input-notif').checked = data ? !!data.notificaciones : true;
      } catch (err) {
        console.log('No se pudo cargar preferencias:', err);
        $('input-notif').checked = true;
      }
    }

    async function handleProfileSave(ev) {
      ev.preventDefault();
      showMsg('Guardando cambios...', 'info', 0);
      const client = await getClient();
      if (!currentUser) {
        const { data, error } = await client.auth.getUser();
        if (error || !data?.user) return showMsg('Sesión inválida', 'error');
        currentUser = data.user;
      }
      const user = currentUser;
      const payload = {
        full_name: $('input-name').value.trim() || null,
        username: $('input-username').value.trim() || null,
        phone: $('input-phone').value.trim() || null,
      };
      const newEmail = $('input-email').value.trim() || null;

      const updateObj = { data: payload };
      if (newEmail && newEmail !== user.email) updateObj.email = newEmail;

      const upd = await client.auth.updateUser(updateObj);
      if (upd.error) return showMsg('No se pudo actualizar: ' + upd.error.message, 'error');

      try {
        await client
          .from('usuarios')
          .update({
            nombre_completo: payload.full_name,
            usuario: payload.username,
            telefono: payload.phone,
            correo_electronico: newEmail || user.email,
          })
          .eq('correo_electronico', user.email);
      } catch (dbErr) {
        console.log('Actualización en usuarios falló (RLS probable):', dbErr);
      }

      showMsg('Perfil actualizado', 'success');
      loadProfile();
    }

    async function handleChangePassword(ev) {
      ev.preventDefault();
      const current = $('input-curr-pass').value;
      const next = $('input-new-pass').value;
      const confirm = $('input-new-pass-confirm').value;
      if (!current || !next || !confirm) return showMsg('Completa todos los campos', 'error');
      if (next !== confirm) return showMsg('Las contraseñas no coinciden', 'error');

      const client = await getClient();
      const email = $('input-email').value.trim();
      const reauth = await client.auth.signInWithPassword({ email, password: current });
      if (reauth.error) return showMsg('Contraseña actual incorrecta', 'error');

      const upd = await client.auth.updateUser({ password: next });
      if (upd.error) return showMsg('No se pudo actualizar: ' + upd.error.message, 'error');

      $('input-curr-pass').value = '';
      $('input-new-pass').value = '';
      $('input-new-pass-confirm').value = '';
      showMsg('Contraseña actualizada', 'success');
    }

    async function handleSavePrefs(ev) {
      ev.preventDefault();
      const client = await getClient();
      if (!currentUser) {
        const { data, error } = await client.auth.getUser();
        if (error || !data?.user) return showMsg('Sesión inválida', 'error');
        currentUser = data.user;
      }
      const enabled = $('input-notif').checked;
      try {
        await client
          .from('preferencias_usuarios')
          .upsert({ user_auth_id: currentUser.id, notificaciones: enabled }, { onConflict: 'user_auth_id' });
        showMsg('Preferencias guardadas', 'success');
      } catch (err) {
        console.error(err);
        showMsg('No se pudieron guardar las preferencias', 'error');
      }
    }

    async function handleAvatarChange(ev) {
      const file = ev.target.files?.[0];
      if (!file) return;
      if (file.size > 4 * 1024 * 1024) return showMsg('La imagen debe pesar menos de 4MB', 'error');
      const client = await getClient();
      if (!currentUser) {
        const { data, error } = await client.auth.getUser();
        if (error || !data?.user) return showMsg('Sesión inválida', 'error');
        currentUser = data.user;
      }

      const ext = file.name.split('.').pop() || 'jpg';
      const path = `${currentUser.id}/${Date.now()}.${ext}`;
      showMsg('Subiendo avatar...', 'info', 0);
      const { error: uploadError } = await client.storage.from('avatars').upload(path, file, { upsert: true });
      if (uploadError) {
        console.error(uploadError);
        return showMsg('No se pudo subir el avatar', 'error');
      }

      try {
        await client.from('usuarios').update({ avatar_path: path }).eq('correo_electronico', currentUser.email);
      } catch (err) {
        console.log('No se pudo guardar avatar en tabla usuarios:', err);
      }

      const env = await fetch('/api/public-env').then((r) => r.json());
      const publicUrl = `${env.url}/storage/v1/object/public/avatars/${encodeURIComponent(path)}`;
      try {
        await client.auth.updateUser({ data: { ...currentUser.user_metadata, avatar_path: path, avatar_url: publicUrl } });
        currentUser.user_metadata = { ...(currentUser.user_metadata || {}), avatar_path: path, avatar_url: publicUrl };
        sessionStorage.setItem('lx_avatar_url', publicUrl);
      } catch (metaErr) {
        console.log('No se pudo actualizar metadata con avatar:', metaErr);
      }
      setAvatar(publicUrl, currentUser.user_metadata?.username || currentUser.email);
      showMsg('Avatar actualizado', 'success');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await getClient();
      await loadProfile();
      $('form-profile').addEventListener('submit', handleProfileSave);
      $('form-pass').addEventListener('submit', handleChangePassword);
      $('form-prefs').addEventListener('submit', handleSavePrefs);
      $('btn-change-avatar').addEventListener('click', () => $('avatarInput').click());
      $('avatarInput').addEventListener('change', handleAvatarChange);
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
