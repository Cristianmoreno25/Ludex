<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ludex — Panel de Desarrollador</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.4/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="../css/developer.css">

 
<body>
  <!-- HEADER oscuro con marca -->
  <header class="topbar dev">
    <div class="brand">
      <!-- gamepad -->
      <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden>
        <path d="M7 10h10l2 2a3 3 0 1 0 3-3v0a3 3 0 0 0-3 3l-2-2H7l-2 2a3 3 0 1 0-3-3v0a3 3 0 0 0 3 3l2-2z" fill="#4f7bff"/>
      </svg>
      <span class="brand-name">Ludex</span>
    </div>

    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-light" id="openDevSettings" title="Ajustes de desarrollador">
        <i class="fa-solid fa-user-gear"></i>
        <span class="d-none d-sm-inline"> Ajustes</span>
      </button>
      <button 
        class="btn-exit-dev" 
        onclick="window.location.href='browse.html'" 
        aria-label="Salir al inicio">
        <i class="fa-solid fa-house"></i>
      </button>
    </div>
  </header>

  <main class="main dev-page" id="mainContent">
    <!-- JUEGOS SUBIDOS -->
    <section class="section" id="uploadedSection">
      <div class="section-header">
        <h2>Juegos Subidos</h2>
        <a href="./add-game.html" class="btn primary">Agregar un nuevo juego</a>
      </div>
      <div id="uploadedList"></div>
    </section>

    <!-- JUEGOS VENDIDOS -->
    <section class="section" id="soldSection">
      <div class="section-header with-link">
        <h2>Juegos Vendidos</h2>
        <a href="#" class="see-more" aria-label="Ver todos" id="seeAllSales">›</a>
      </div>
      <div id="soldList"></div>
    </section>

    <!-- ESTADÍSTICAS -->
    <section class="section">
      <div class="section-header-stats d-flex align-items-center justify-content-between mb-3">
        <h2 class="h5 mb-0">Estadísticas de Venta</h2>
      </div>
      <div class="container stats-container" style="max-width:1100px;">
        <div class="row g-3 align-items-stretch">
          <div class="col-lg-8">
            <div class="card h-100">
              <div class="card-body">
                <h3 class="h6">Resumen por juego</h3>

                <div class="table-wrapper mt-2">
                  <table class="table table-hover align-middle" id="gamesTable">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Juego</th>
                        <th scope="col">Ventas</th>
                        <th scope="col">Cant. descargas</th>
                        <th scope="col">Valor ganado (USD)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr data-ventas="120" data-descargas="1500" data-valor="2400">
                        <td class="fw-semibold">Starbound Arena</td>
                        <td>120</td>
                        <td>1,500</td>
                        <td>$2,400.00</td>
                      </tr>
                      <tr data-ventas="80" data-descargas="900" data-valor="1200">
                        <td class="fw-semibold">Moon Raider</td>
                        <td>80</td>
                        <td>900</td>
                        <td>$1,200.00</td>
                      </tr>
                      <tr data-ventas="45" data-descargas="450" data-valor="540">
                        <td class="fw-semibold">Potion Pack</td>
                        <td>45</td>
                        <td>450</td>
                        <td>$540.00</td>
                      </tr>
                      <tr data-ventas="210" data-descargas="3200" data-valor="6300">
                        <td class="fw-semibold">Rogue Legacy X</td>
                        <td>210</td>
                        <td>3,200</td>
                        <td>$6,300.00</td>
                      </tr>
                      <tr data-ventas="10" data-descargas="120" data-valor="80">
                        <td class="fw-semibold">Mini Golf VR</td>
                        <td>10</td>
                        <td>120</td>
                        <td>$80.00</td>
                      </tr>
                      <tr data-ventas="65" data-descargas="850" data-valor="975">
                        <td class="fw-semibold">Pixel Pirates</td>
                        <td>65</td>
                        <td>850</td>
                        <td>$975.00</td>
                      </tr>
                      <tr data-ventas="32" data-descargas="300" data-valor="256">
                        <td class="fw-semibold">Neon Drift</td>
                        <td>32</td>
                        <td>300</td>
                        <td>$256.00</td>
                      </tr>
                      <tr data-ventas="5" data-descargas="60" data-valor="30">
                        <td class="fw-semibold">PuzzleBox</td>
                        <td>5</td>
                        <td>60</td>
                        <td>$30.00</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Paginación numerica (tabla) -->
                <nav aria-label="Paginación de tabla" class="mt-3">
                  <ul class="pagination pagination-sm mb-0" id="tablePager">
                    <!-- Items generados por JS -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card card-chart h-100">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h3 class="h6 mb-0">Gráfico</h3>
                  <select class="form-select form-select-sm w-auto" id="chartTypeSelect" aria-label="Seleccionar tipo de gráfico">
                    <option value="bar">Barras</option>
                    <option value="line">Línea</option>
                    <option value="pie">Pie</option>
                    <option value="doughnut">Doughnut</option>
                  </select>
                </div>

                <canvas id="statsChart" style="max-height:360px"></canvas>

                <div class="mt-3 text-end">
                  <button class="btn btn-sm btn-outline-secondary" id="exportCsv">Exportar CSV</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AYUDA -->
    <section class="section">
      <h2>Ayuda</h2>
      <div class="help-card">
        <p>Para ayuda con la navegación o funciones, por favor consulta nuestra guía de usuario o contacta soporte.</p>
        <a href="update-Developer.html" class="btn primary align-end">Subir Actualización</a>
      </div>
    </section>
  </main>

  <!-- NAV INFERIOR -->
  <nav class="bottom-nav dev" aria-label="Navegación">
    <a class="nav-btn" aria-label="Inicio" href="./developer.html">
      <i class="fa-solid fa-house"></i>
    </a>
    <a class="nav-btn active" aria-label="Panel de desarrollador" href="./Profile.html">
      <i class="fa-solid fa-user-gear"></i>
    </a>
</nav>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Supabase SDK para validar acceso al panel -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Modal: Ajustes del Desarrollador -->
  <div class="modal fade" id="devSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px;overflow:hidden">
        <div class="modal-header" style="background:linear-gradient(90deg,#4338ca,#7c3aed);color:#fff">
          <h5 class="modal-title">Ajustes de Desarrollador</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="devSettingsMsg" class="mb-2"></div>
          <form id="devSettingsForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nombre del estudio</label>
              <input type="text" class="form-control" id="ds_nombre_estudio" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Razón social</label>
              <input type="text" class="form-control" id="ds_razon_social" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">NIT / Tax ID</label>
              <input type="text" class="form-control" id="ds_nit" placeholder="No editable" disabled>
              <div class="form-text">Para cambiar el NIT contacta soporte.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">País</label>
              <select id="ds_pais_id" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Dirección</label>
              <input type="text" class="form-control" id="ds_direccion">
            </div>
            <div class="col-md-6">
              <label class="form-label">Teléfono</label>
              <input type="tel" class="form-control" id="ds_telefono">
            </div>
            <div class="col-md-6">
              <label class="form-label">Sitio web</label>
              <input type="url" class="form-control" id="ds_website" placeholder="https://...">
            </div>
            <div class="col-md-6">
              <label class="form-label">GitHub / Portafolio</label>
              <input type="url" class="form-control" id="ds_github" placeholder="https://github.com/...">
            </div>
          </form>
          <div class="mt-3 d-flex justify-content-between align-items-center">
            <button class="btn btn-danger" id="ds_delete">Dar de baja cuenta de desarrollador</button>
            <button class="btn btn-primary" id="ds_save">Guardar cambios</button>
          </div>
          <div class="text-muted mt-2" style="font-size:.85rem">Al dar de baja, se elimina tu registro de desarrollador y tu rol volverá a 'cliente'.
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    (async function guardDeveloperPanel(){
      try {
        const env = await (await fetch('/api/public-env')).json();
        const client = window.supabase.createClient(env.url, env.key);
        const { data: { user } } = await client.auth.getUser();
        if (!user) { window.location.href = '/html/login.html'; return; }
        const { data, error } = await client
          .from('desarrolladores')
          .select('estado_verificacion')
          .eq('user_auth_id', user.id)
          .maybeSingle();
        if (error || !data || data.estado_verificacion !== 'verificado') {
          window.location.href = '/html/developer-register.html';
        }
      } catch (e) {
        // En caso de fallo, forzar a registro
        window.location.href = '/html/developer-register.html';
      }
    })();
  </script>

  <script>
    // ------------------ Configuración y utilidades ------------------
    const rowsPerPage = 5;
    let currentPage = 1;
    const table = document.getElementById('gamesTable');
    const tbody = table.querySelector('tbody');
    const pager = document.getElementById('tablePager');
    const chartCtx = document.getElementById('statsChart');
    let chartInstance = null;
    let tableData = [];

    // Leer todas las filas como un array
    let allRows = Array.from(tbody.querySelectorAll('tr'));

    // ---------- Paginador simple (cliente) ----------
    function renderPager(){
      const totalPages = Math.ceil(allRows.length / rowsPerPage);
      pager.innerHTML = '';
      for(let p=1; p<=totalPages; p++){
        const li = document.createElement('li');
        li.className = 'page-item' + (p === currentPage ? ' active' : '');
        const a = document.createElement('button');
        a.className = 'page-link btn btn-sm';
        a.textContent = p;
        a.addEventListener('click', () => { currentPage = p; showPage(p); });
        li.appendChild(a);
        pager.appendChild(li);
      }
    }

    function showPage(page){
      const start = (page-1) * rowsPerPage;
      const end = start + rowsPerPage;
      allRows.forEach((r, idx) => {
        r.style.display = (idx >= start && idx < end) ? '' : 'none';
      });
      // actualizar gráfico con las filas visibles
      renderChart(currentChartType);
      // actualizar pager activo
      Array.from(pager.children).forEach((li, i) => {
        li.classList.toggle('active', i === page-1);
      });
    }

    // ---------- Datos para gráficos (se usan las filas actualmente visibles) ----------
    function getVisibleRowsData(){
      const visible = Array.from(tbody.querySelectorAll('tr')).filter(r => r.style.display !== 'none');
      const labels = visible.map(r => r.children[0].textContent.trim());
      const ventas = visible.map(r => Number(r.dataset.ventas || r.children[1].textContent.replace(/[^0-9.-]/g,'')));
      const valor = visible.map(r => Number(r.dataset.valor || r.children[3].textContent.replace(/[^0-9.-]/g,'')));
      const descargas = visible.map(() => 0);
      return { labels, ventas, descargas, valor };
    }

    // ---------- Chart rendering (Chart.js) ----------
    let currentChartType = 'bar';
    function renderChart(type){
      const data = getVisibleRowsData();
      const cfg = {
        type: type,
        data: {},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: {}
        }
      };

      if(type === 'pie' || type === 'doughnut'){
        cfg.data = {
          labels: data.labels,
          datasets: [{
            label: 'Valor ganado (USD)',
            data: data.valor,
            // default Chart.js colors will be used
          }]
        };
      } else {
        cfg.data = {
          labels: data.labels,
          datasets: [
            { label: 'Ventas', data: data.ventas, tension: 0.2, borderWidth: 1, fill: false },
            { label: 'Descargas', data: data.descargas, tension: 0.2, borderWidth: 1, fill: false }
          ]
        };
        cfg.options.scales = { y: { beginAtZero: true } };
      }

      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(chartCtx, cfg);
      currentChartType = type;
    }

    // ---------- Nav para seleccionar tipo de gráfico ----------
    const chartTypeSelect = document.getElementById('chartTypeSelect');
    chartTypeSelect.addEventListener('change', (e) => {
      renderChart(e.target.value);
    });

    // ---------- Funciones auxiliares ----------
    function viewGame(btn){
      const tr = btn.closest('tr');
      alert('Abrir detalle: ' + tr.children[0].textContent.trim());
    }

    function openNotif(id){ alert('Abrir: ' + id); }
    function markRead(id){ alert('Marcar leído: ' + id); }
    function dismiss(id){ alert('Descartar: ' + id); }

    // Exportar CSV
    document.getElementById('exportCsv').addEventListener('click', () => {
      const rows = Array.from(tbody.querySelectorAll('tr')).map(r => {
        const cells = Array.from(r.children).slice(0,4).map(td => td.textContent.trim().replace(/\$/g,''));
        return cells.join(',');
      });
      const csv = ['Juego,Ventas,Descargas,Valor'].concat(rows).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'estadisticas_juegos.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Inicialización: cargar datos reales
    (async function init(){
      try {
        const env = await (await fetch('/api/public-env')).json();
        const client = window.supabase.createClient(env.url, env.key);
        const { data: { user } } = await client.auth.getUser();
        if (!user) { window.location.href = '/html/login.html'; return; }

        // Juegos subidos
        const { data: games } = await client
          .from('juegos')
          .select('id, titulo, descripcion, estado, precio, precio_descuento, calificacion_media, calificaciones_total, actualizado_en')
          .eq('developer_auth_id', user.id)
          .order('actualizado_en', { ascending: false });
        renderUploaded(games || []);

        // Resumen de ventas por juego (RPC)
        const { data: summary } = await client.rpc('dev_sales_summary');
        renderSales(summary || []);
        buildTableFromSummary(summary || []);

        renderPager();
        showPage(1);
        renderChart(currentChartType);
      } catch(e) {
        console.error(e);
      }
    })();

    function renderUploaded(list){
      const wrap = document.getElementById('uploadedList');
      if (!wrap) return;
      wrap.innerHTML = '';
      if (!list || !list.length){
        wrap.innerHTML = '<div class="text-muted">Aún no has subido juegos.</div>';
        return;
      }
      list.forEach(j => {
        const art = document.createElement('article');
        art.className = 'game-card uploaded';
        const precio = (j.precio_descuento ?? j.precio) || 0;
        art.innerHTML = `
          <header class="game-head">
            <h3><em>${escapeHtml(j.titulo)}</em></h3>
            <span class="badge bg-${j.estado==='publicado'?'success':(j.estado==='revision'?'warning':'secondary')}">${j.estado}</span>
          </header>
          <p class="meta">Actualizado: ${new Date(j.actualizado_en||Date.now()).toLocaleString()}</p>
          <p class="desc">${escapeHtml(j.descripcion||'Sin descripción')}</p>
          <div class="actions">
            <span class="me-2">Precio: $${Number(precio).toFixed(2)}</span>
            <button class="btn secondary small" onclick="window.location.href='edit-game.html?id=${j.id}'">Editar</button>
          </div>`;
        wrap.appendChild(art);
      });
    }

    function renderSales(summary){
      const wrap = document.getElementById('soldList');
      if (!wrap) return;
      wrap.innerHTML='';
      const top = (summary||[]).filter(r=>Number(r.ventas)>0).slice(0,4);
      if (!top.length){
        wrap.innerHTML = '<div class="text-muted">Aún no hay ventas.</div>';
        return;
      }
      top.forEach(r => {
        const art = document.createElement('article');
        art.className = 'game-card sold';
        art.innerHTML = `
          <h3><em>${escapeHtml(r.titulo)}</em></h3>
          <p class="meta">Total vendidos: ${r.ventas}</p>
          <p class="desc">Ingresos: $${Number(r.valor||0).toFixed(2)}</p>`;
        wrap.appendChild(art);
      });
    }

    function buildTableFromSummary(summary){
      tbody.innerHTML = '';
      tableData = [];
      (summary||[]).forEach(r => {
        const tr = document.createElement('tr');
        tr.dataset.ventas = String(r.ventas||0);
        tr.dataset.valor = String(r.valor||0);
        tr.innerHTML = `
          <td class="fw-semibold">${escapeHtml(r.titulo)}</td>
          <td>${r.ventas||0}</td>
          <td>—</td>
          <td>$${Number(r.valor||0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
        tableData.push({ titulo: r.titulo, ventas: r.ventas||0, valor: r.valor||0 });
      });
      allRows = Array.from(tbody.querySelectorAll('tr'));
      const up = document.getElementById('updatedAt'); if (up) up.textContent = new Date().toLocaleString();
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]||c));
    }

    function salirModoDesarrollador() {
      window.location.href = "index.html"; 
    }

    // -------- Ajustes del desarrollador (modal) --------
    (function setupDevSettings(){
      const btnOpen = document.getElementById('openDevSettings');
      const modalEl = document.getElementById('devSettingsModal');
      const msg = document.getElementById('devSettingsMsg');
      const f = {
        nombre: document.getElementById('ds_nombre_estudio'),
        razon: document.getElementById('ds_razon_social'),
        nit: document.getElementById('ds_nit'),
        pais: document.getElementById('ds_pais_id'),
        dir: document.getElementById('ds_direccion'),
        tel: document.getElementById('ds_telefono'),
        web: document.getElementById('ds_website'),
        gh: document.getElementById('ds_github'),
      };
      let bsModal = null;

      function showMsg(text, type='info'){
        const cls = type==='error' ? 'alert-danger' : (type==='success'?'alert-success':'alert-secondary');
        msg.innerHTML = `<div class="alert ${cls} py-2 mb-2">${text}</div>`;
      }

      async function loadCountries(){
        try{
          const r = await fetch('/api/paises');
          const j = await r.json();
          const list = j.paises || [];
          f.pais.innerHTML = '<option value="">(Opcional)</option>' + list.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        } catch{}
      }

      async function loadProfile(){
        const env = await (await fetch('/api/public-env')).json();
        const client = window.supabase.createClient(env.url, env.key);
        const { data: { user } } = await client.auth.getUser();
        if (!user) { window.location.href = '/html/login.html'; return; }
        const { data } = await client
          .from('desarrolladores')
          .select('*')
          .eq('user_auth_id', user.id)
          .maybeSingle();
        if (data){
          f.nombre.value = data.nombre_estudio || '';
          f.razon.value = data.razon_social || '';
          f.nit.value = data.nit || '';
          f.dir.value = data.direccion || '';
          f.tel.value = data.telefono || '';
          try { f.pais.value = data.pais_id ? String(data.pais_id) : ''; } catch{}
          const docs = data.documentos || {};
          f.web.value = docs.website || '';
          f.gh.value = docs.github || '';
        }
      }

     btnOpen?.addEventListener('click', async ()=>{
        await loadCountries();
        await loadProfile();
        // @ts-ignore
        bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();
        });
        
      document.getElementById('ds_save')?.addEventListener('click', async ()=>{
        try{
          showMsg('Guardando...');
          const env = await (await fetch('/api/public-env')).json();
          const client = window.supabase.createClient(env.url, env.key);
          const { data: { user } } = await client.auth.getUser();
          const patch = {
            nombre_estudio: f.nombre.value.trim(),
            razon_social: f.razon.value.trim(),
            direccion: f.dir.value.trim() || null,
            pais_id: f.pais.value ? Number(f.pais.value) : null,
            telefono: f.tel.value.trim() || null,
            documentos: { website: f.web.value.trim() || null, github: f.gh.value.trim() || null },
          };
          const { error } = await client
            .from('desarrolladores')
            .update(patch)
            .eq('user_auth_id', user.id);
          if (error) throw error;
          showMsg('Cambios guardados', 'success');
          setTimeout(()=> bsModal?.hide(), 600);
        } catch(e){
          showMsg(e.message||'No se pudo guardar', 'error');
        }
      });

      document.getElementById('ds_delete')?.addEventListener('click', async ()=>{
        if (!confirm('¿Seguro que deseas dar de baja tu cuenta de desarrollador?')) return;
        try{
          showMsg('Procesando baja...');
          const env = await (await fetch('/api/public-env')).json();
          const client = window.supabase.createClient(env.url, env.key);
          const { error } = await client.rpc('dev_deregister');
          if (error) throw error;
          showMsg('Tu cuenta de desarrollador fue dada de baja.', 'success');
          setTimeout(()=>{ window.location.href = '/html/Profile.html'; }, 700);
        } catch(e){
          showMsg(e.message||'No se pudo dar de baja', 'error');
        }
      });
    })();
  </script>
</body>
</html>
